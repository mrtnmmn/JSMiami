<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSMiami</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"
    integrity="sha512-N4kV7GkNv7QR7RX9YF/olywyIgIwNvfEe2nZtfyj73HdjCUkAfOBDbcuJ/cTaN04JKRnw1YG1wnUyNKMsNgg3g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"
    integrity="sha512-WzkwpdWEMAY/W8WvP9KS2/VI6zkgejR4/KTxTl4qHx0utqeyVE0JY+S1DlMuxDChC7x0oXtk/ESji6a0lP/Tdg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="libraries/scenemanager.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script defer src="https://unpkg.com/p5.collide2d"></script>
    <script src="scripts/pj.js"></script>
    <script src="scripts/bullet.js"></script>
    <script src="scripts/enemies/dog.js"></script>
    <script src="scripts/enemies/enemyKnife.js"></script>

</head>
<body>
    <script>
        let pj
        let mill = 0
        // borrar: 
        let milldog = 0

        let bullets = []
        let enemies = []
        let killKounter = 0

        let round1 = []

        let mainTheme 
        let playing = false 
        let shotM16

        let gradual

        let startTransition

        function preload() {
            mainTheme = loadSound('sounds/soundtrack/horseStepping.mp3')
            normalTheme = loadSound('sounds/soundtrack/hydrogen.mp3')
        }

        function setup() {
            shotM16 = loadSound('sounds/shots/M16Shot.mp3')
            gradual = loadImage('sprites/nightmare/nightmare_big.png')
            createCanvas(800 , 800)
            pj = new Pj()

            mgr = new SceneManager()

            mgr.addScene(mainMenu)
            mgr.addScene(normalMode)
            mgr.addScene(nightmareTransition)
            mgr.addScene(nightmareMode)

            mgr.showScene(mainMenu)
        }

        function mainMenu() {

            if (!playing) {
                mainTheme.play()
                playing = true
            }

            circles = [[200,200,50, 0], [600,200,50, 1]]

            this.draw = function() {

                background(150)

                circle(200,200,50)
                circle(600,200,50)

                checkKeys()
                printBullets()
                printPj()
                this.checkBullet()
 
            }

            this.checkBullet = function() {
                bullets.forEach(function(bullet) {
                    circles.forEach(function(circle) { 
                        let hit = false 
                        hit = collideCircleCircle(bullet.x, bullet.y, 5, circle[0], circle[1], circle[2])
                        if (hit) {
                            if (circle[3] === 1) {
                                mainTheme.stop()
                                playing = false
                                startTransition = millis()
                                pj.x = 400
                                pj.y = 400
                                mgr.showScene(nightmareTransition)
                            }
                            else if (circle[3] === 0) {
                                mainTheme.stop()
                                playing = false
                                mgr.showScene(normalMode)
                            }
                        }
                    })
                })
            }

        }

        function normalMode() {

            this.draw = function() {
                if (!playing) {
                    startSong()
                    playing = true
                }

                if(pj.isAlive) {

                    checkKeys()

                    if (pj.ammo === 0) {
                        pj.reload(millis())
                    } 

                    checkSpawn(40)
                    background(150)
                    printKills()
                    printInfo()
                    printBullets()
                    checkBulletEnemyCollision()
                    checkEnemyPjColision()
                    enemies.forEach(enemy => enemy.dibujar(pj.x + pj.middleX, pj.y + pj.middleY))
                    printPj()
                    printAmmo()
                }
            }
        }


        function nightmareTransition() {

            this.draw = function() {
                background('#000000')
                push()
                fill(255, 255, 255)
                textSize(32)
                textAlign(CENTER)
                text('YOU ARE GONNA HAVE A BAD TIME', 400, 400)
                pop()
                this.checkChange()
            }

            this.checkChange = function() {
                console.log(millis() - this.start)
                if ((millis() - startTransition) > 5000) {
                    mgr.showScene(nightmareMode)
                }
            }

        }

        function nightmareMode() {

            this.draw = function() {

                if (!playing) {
                    startSong()
                    playing = true
                }

                if(pj.isAlive) {

                    checkKeys()

                    if (pj.ammo === 0) {
                        pj.reload(millis())
                    } 

                    checkSpawn(40)
                    background(150)
                    printKills()
                    printInfo()
                    printBullets()
                    checkBulletEnemyCollision()
                    checkEnemyPjColision()
                    enemies.forEach(enemy => enemy.dibujar(pj.x + pj.middleX, pj.y + pj.middleY))
                    printPj()
                    drawNightmare()
                }
            }
        }

        function startSong() {
            normalTheme.play();
        }

        function draw() {
            mgr.draw()
        }

        /*
        function draw() {

            if (!playing) {
                startSong()
                playing = true
            }

            if(pj.isAlive) {

                checkKeys()

                if (pj.ammo === 0) {
                    pj.reload(millis())
                } 

                checkSpawn(40)
                background(150)
                printKills()
                printInfo()
                printBullets()
                checkBulletEnemyCollision()
                checkEnemyPjColision()
                enemies.forEach(enemy => enemy.dibujar(pj.x + pj.middleX, pj.y + pj.middleY))
                printPj()
                printAmmo()
                drawNightmare()


            }
        } */

        function drawNightmare() {
            push()
            translate(pj.x + 25, pj.y + 8)
            image(gradual, -800, -800)
            pop()

            push()
            fill(255,255,255)
            printKills()
            pop()

        }

        function checkKeys() {
            if (keyIsDown(65)) {
                pj.left()
            }

            if (keyIsDown(68)) {
                pj.right()
            }

            if (keyIsDown(87)) {
                pj.up()
            }
            
            if (keyIsDown(83)) {
                pj.down()
            }

            if (keyIsDown(77)) {
                pj.die()
            }

            if (mouseIsPressed) {
                if (millis() >=  mill + 100 && pj.ammo != 0) {
                    mill = millis()
                    pj.shoot(millis())
                    bullets.push(b = new bullet(pj.x + 25 ,pj.y + 8, calculateAngle() ))
                    shotM16.play()
                } /*else if (pj.ammo === 0) {
                    pj.reload(millis())
                } */
            }

            if (keyIsDown(82)) {
                if (pj.ammo != 30) {
                    pj.ammo = 0
                }
            }

            if (keyIsDown(84)) {
                if (millis() >=  milldog + 200) {
                    milldog = millis()
                    enemies.push(new dog(0, calculateRandomMN(0,800)))    
                    enemies.push(new enemyKnife(800, calculateRandomMN(0,800)))  
                    enemies.push(new enemyKnife(0, calculateRandomMN(0,800)))          
                }
            }
        }

        function calculateAngle() {
            push() 
            translate(pj.x + 25, pj.y + 8)
            let radians = atan2(mouseY - (pj.y + 8) , mouseX - (pj.x+ 25))
            pop()
            return radians
        }

        function printBullets() {
            bullets.forEach(bullet => bullet.dibujar())
            bullets.forEach(bullet => bullet.checkCollision())
            bullets = bullets.filter(bullet => bullet.onAir === true)
        }

        function checkBulletEnemyCollision() {
            bullets.forEach(function(bullet) {
                enemies.forEach(function(enemy) {
                    if (enemy.isAlive) {
                        let hit = false
                        hit = collideCircleCircle(bullet.x, bullet.y, 5, (enemy.x + enemy.middleX), (enemy.y + enemy.middleY), enemy.middleX * 2)
                        if (hit) {
                            enemy.isAlive = false
                            bullet.onAir = false
                            killKounter += 1
                        }
                    }
                })
            })
        }

        function printPj() {
            push()
            translate(pj.x + 25, pj.y + 8);
            let a = atan2(mouseY - (pj.y + 8) , mouseX - (pj.x+ 25));
            rotate(a+0.07);
            pj.dibujar()
            pop()
        }

        function checkEnemyPjColision() {
            enemies.forEach(function(enemy) {
                if (enemy.isAlive) {
                    let hit = false 
                    hit = collideCircleCircle((pj.x + pj.middleX), (pj.y + pj.middleY), pj.middleY, (enemy.x + enemy.middleX), (enemy.y + enemy.middleY), enemy.middleX * 2)
                    if (hit) {
                        pj.isAlive = false
                    }
                }
            })
        }

        function printAmmo() {

            let ammo = pj.ammo 

            if (ammo != 0) {
                text('ammo: ' + pj.ammo + '/' + pj.maxAmmo, 700,790)
            } else {
                text('Reloading...' , 700,790)
            }
        }

        function calculateRandomMN(m, n) {
            return Math.round(Math.random()*(m-n)+n)
        }

        function printInfo() {
            text('Clk izq: disparar - wasd: movimiento - r: recargar - t: spawnear enemigos', 7, 15 )
        }

        // rounds
        round1.forEach(function(func) {
            func()   
        })


        // spawn functions 

        function spawnDog() {
            let position = calculateSpawn()
            enemies.push(new dog(position[0], position[1]))
        }

        function spawnKnife() {
            let position = calculateSpawn() 
            enemies.push(new enemyKnife(position[0], position[1]))
        }

        function checkSpawn(n) {
            decision = calculateRandomMN(n,1)

            if (decision === 1) {
                spawnRandomEnemy()
            }
        }

        function spawnRandomEnemy() {
            let decision = coinflip()

            let coord = calculateSpawn() 

            if (decision === 1) {
                enemies.push(new dog(coord[0], coord[1]))
            } else {
                enemies.push(new enemyKnife(coord[0], coord[1]))
            }
        }

        // functions to determine spawn point in the perimeter equivalent to 
        // a rectangle with coordinates 
        // [[-100, -100], [900, -100], [-100, 900], [900, 900]] 
        function coinflip() {
            return Math.round(Math.random()*(2-1)+1)
        }

        function calculateSpawn() {
            let decision =  coinflip()

            if (decision === 1) {
                return calculateArroundX()
            } else {
                return calculateArroundY()
            }
        }

        function calculateArroundX() {
            let decision = coinflip()

            let x = 0
            let y = calculateSecondPosition()

            if (decision === 1) {
                x = -100 
            } else {
                x = 900
            }

            return [x, y] 
        }

        function calculateArroundY() {
            let decision = coinflip()

            let y = 0
            let x = calculateSecondPosition()

            if (decision === 1) {
                y = -100 
            } else {
                y = 900
            }           

            return [x, y]
        }

        function calculateSecondPosition() {
            let decision = calculateRandomMN(10,1)

            if (decision === 1) {
                return (calculateRandomMN(100, 0) * (-1))
            } else {
                return calculateRandomMN(900,0)
            }
        }

        function printKills() {
            text('kills: ' + killKounter , 10, 790)
        }

    </script>
</body>
</html>