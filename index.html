<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSMiami</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"
    integrity="sha512-N4kV7GkNv7QR7RX9YF/olywyIgIwNvfEe2nZtfyj73HdjCUkAfOBDbcuJ/cTaN04JKRnw1YG1wnUyNKMsNgg3g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"
    integrity="sha512-WzkwpdWEMAY/W8WvP9KS2/VI6zkgejR4/KTxTl4qHx0utqeyVE0JY+S1DlMuxDChC7x0oXtk/ESji6a0lP/Tdg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="styles.css">
    <script defer src="https://unpkg.com/p5.collide2d"></script>
    <script src="scripts/pj.js"></script>
    <script src="scripts/bullet.js"></script>
    <script src="scripts/enemies/dog.js"></script>
    <script src="scripts/enemies/enemyKnife.js"></script>

</head>
<body>
    <script>
        let pj
        let mill = 0
        // borrar: 
        let milldog = 0

        let bullets = []
        let enemies = []

        let round1 = []

        let mainTheme 
        let playing = false 
        let shotM16

        function preload() {
            mainTheme = loadSound('sounds/soundtrack/hydrogen.mp3')
        }

        function setup() {
            shotM16 = loadSound('sounds/shots/M16Shot.mp3')
            createCanvas(800 , 800)
            pj = new Pj()
        }

        function startSong() {
            mainTheme.play();

        }

        function draw() {

            if (!playing) {
                startSong()
                playing = true
            }

            if(pj.isAlive) {
                if (keyIsDown(65)) {
                    pj.left()
                }

                if (keyIsDown(68)) {
                    pj.right()
                }

                if (keyIsDown(87)) {
                    pj.up()
                }
            
                if (keyIsDown(83)) {
                    pj.down()
                }

                if (keyIsDown(77)) {
                    pj.die()
                }

                if (mouseIsPressed) {
                    if (millis() >=  mill + 100 && pj.ammo != 0) {
                        mill = millis()
                        pj.shoot(millis())
                        bullets.push(b = new bullet(pj.x + 25 ,pj.y + 8, calculateAngle() ))
                        shotM16.play()
                    } /*else if (pj.ammo === 0) {
                        pj.reload(millis())
                    } */
                }
            
                if (pj.ammo === 0) {
                    pj.reload(millis())
                } 

                if (keyIsDown(82)) {
                    pj.ammo = 0
                }

                if (keyIsDown(84)) {
                    if (millis() >=  milldog + 200) {
                        milldog = millis()
                        enemies.push(new dog(0, calculateRandomMN(0,800)))    
                        enemies.push(new enemyKnife(800, calculateRandomMN(0,800)))  
                        enemies.push(new enemyKnife(0, calculateRandomMN(0,800)))          

                    }
                }


                background(150)

                printBullets()
                checkBulletEnemyCollision()

                checkEnemyPjColision()

                enemies.forEach(enemy => enemy.dibujar(pj.x + pj.middleX, pj.y + pj.middleY))

                printPj()
                printAmmo()

            }
        }

        function calculateAngle() {
            push() 
            translate(pj.x + 25, pj.y + 8)
            let radians = atan2(mouseY - (pj.y + 8) , mouseX - (pj.x+ 25))
            pop()
            return radians
        }

        function printBullets() {
            bullets.forEach(bullet => bullet.dibujar())
            bullets.forEach(bullet => bullet.checkCollision())
            bullets = bullets.filter(bullet => bullet.onAir === true)
        }

        function checkBulletEnemyCollision() {
            bullets.forEach(function(bullet) {
                enemies.forEach(function(enemy) {
                    console.log(bullet.x, bullets.indexOf(bullet))
                    let hit = false
                    hit = collideCircleCircle(bullet.x, bullet.y, 5, (enemy.x + enemy.middleX), (enemy.y + enemy.middleY), enemy.middleX * 2)
                    if (hit) {
                        enemy.isAlive = false
                        bullet.onAir = false
                    }
                })
            })
        }

        function printPj() {
            push()
            translate(pj.x + 25, pj.y + 8);
            let a = atan2(mouseY - (pj.y + 8) , mouseX - (pj.x+ 25));
            rotate(a);
            pj.dibujar()
            pop()
        }

        function checkEnemyPjColision() {
            enemies.forEach(function(enemy) {
                if (enemy.isAlive) {
                    let hit = false 
                    hit = collideCircleCircle((pj.x + pj.middleX), (pj.y + pj.middleY), pj.middleY, (enemy.x + enemy.middleX), (enemy.y + enemy.middleY), enemy.middleX * 2)
                    if (hit) {
                        pj.isAlive = false
                    }
                }
            })
        }

        function printAmmo() {

            let ammo = pj.ammo 

            if (ammo != 0) {
                text('ammo: ' + pj.ammo + '/' + pj.maxAmmo, 700,790)
            } else {
                text('Reloading...' , 700,790)
            }
        }

        function calculateRandomMN(m, n) {
            return Math.round(Math.random()*(m-n)+n)
        }

    </script>
</body>
</html>