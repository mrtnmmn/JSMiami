<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSMiami</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"
    integrity="sha512-N4kV7GkNv7QR7RX9YF/olywyIgIwNvfEe2nZtfyj73HdjCUkAfOBDbcuJ/cTaN04JKRnw1YG1wnUyNKMsNgg3g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"
    integrity="sha512-WzkwpdWEMAY/W8WvP9KS2/VI6zkgejR4/KTxTl4qHx0utqeyVE0JY+S1DlMuxDChC7x0oXtk/ESji6a0lP/Tdg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="libraries/scenemanager.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script defer src="https://unpkg.com/p5.collide2d"></script>
    <script src="scripts/pj.js"></script>
    <script src="scripts/bullet.js"></script>
    <script src="scripts/enemies/dog.js"></script>
    <script src="scripts/enemies/enemyKnife.js"></script>
    <script src="scripts/enemies/enemyM16.js"></script>

</head>
<body>
    <script>
        let pj
        let pjAngle
        let mill = 0

        // menu
        let opciones = ["Normal", "Nightmare", "Select Weapon", "Select Mask"]
        let weapons = ["Pistol", "M16", "Shotgun"]
        let masksNames = ["Richard", "Peter", "Rick", "Brandon"]  
        let masksInfo = ["Pro guy", "More bullets", "Faster reload", "Does speed"]
        let maskImages = []
        let selectedOption = 0
        let selectedMask = 0 
        let cooldown= 0

        let richard 
        let peter
        let rick 
        let brandon

        // borrar: 
        let milldog = 0

        let bullets = []
        let enemies = []

        let shotsFired = 0
        let shotsLanded = 0
        let killKounter = 0
        let startTime = 0
        let finalTime = 0
        let spawnTime = 0
        let spawnCap = 0
        let lastSpawn = 0

        let round1 = []

        let mainTheme 
        let playing = false 
        let shotM16

        let gradual
        let deathOverlay
        let cursor

        let startNightmareTransition = 0

        function preload() {
            mainTheme = loadSound('sounds/soundtrack/horseStepping.mp3')
            normalTheme = loadSound('sounds/soundtrack/hydrogen.mp3')
            shotgunFont = loadFont('fonts/shotgun.ttf')
            wideAwake = loadFont('fonts/WIDEAWAKE.TTF')
            wideAwakeBlack = loadFont('fonts/WIDEAWAKEBLACK.ttf')
            
            shotM16 = loadSound('sounds/shots/M16Shot.mp3')
            gradual = loadImage('sprites/nightmare/nightmare_big.png')
            deathOverlay = loadImage('sprites/overlay_death.png')
            bgMain = loadImage('sprites/bgMain.png')
            cursor = loadImage('sprites/sprCursor.png')

            //loadMasks
            richard = loadImage('sprites/masks/richardBig.png')
            peter = loadImage('sprites/masks/peterBig.png')
            rick = loadImage('sprites/masks/rickBig.png')
            brandon = loadImage('sprites/masks/brandonBig.png')
            maskImages.push(richard)
            maskImages.push(peter)
            maskImages.push(rick)
            maskImages.push(brandon) 
        }

        function setup() {

            createCanvas(800 , 800)
            pj = new Pj()

            mgr = new SceneManager()

            mgr.addScene(mainMenu)
            mgr.addScene(normalMode)
            mgr.addScene(nightmareTransition)
            mgr.addScene(nightmareMode)
            mgr.addScene(maskSelection)

            mgr.showScene(mainMenu)
        }

        function mainMenu() {

            this.draw = function() {

                if (!playing) {
                    mainTheme.play()
                    playing = true
                }

                background(150)

                image(bgMain, 0, 0)

                if (millis() - cooldown > 150) {
                    checkKeysMenu()                
                }

                push()
                textSize(200)
                textAlign(CENTER)
                fill(160, 0, 255)
                textFont(wideAwake)
                this.printTitle()
                textSize(100)
                drawMenu()
                checkSelection()
                pop()

                printCross()
                
            }

            this.printTitle = function() {
                text('JSMiami', 400, 240)
                push()
                fill(255, 255, 255) 
                textFont(wideAwakeBlack)
                text('JSMiami', 400, 240)
                pop()
            }

        }

        function drawMenu() {

            for (let i = 0; i < opciones.length; i ++) {
                push()
                checkSelection(i)
                text(opciones[i], 400, 120* i + 380)
                textFont(wideAwakeBlack)
                fill(255, 255, 255)
                text(opciones[i], 400, 120 * i + 380)
                pop()

            }

        }

        function checkSelection(x) {
            if (selectedOption === x) {
                fill(0,0,255)
            }
            else {
                fill(255, 0, 255)
            }
        } 

        function maskSelection() {


            this.draw = function() {
                background(150)

                image(bgMain, 0, 0)

                this.drawSelection()
                this.checkKeysMaskSelection()
            }

            this.drawSelection = function() {
                push()
                imageMode(CENTER)
                image(maskImages[this.otherMask(-1)],200,200, 200, 200)
                image(maskImages[selectedMask], 400, 200, 400, 400)
                image(maskImages[this.otherMask(1)],600,200, 200, 200)
                pop()

                this.drawMaskName()
                this.drawMaskInfo()
            }

            this.drawMaskName = function() {
                push()
                textAlign(CENTER)
                fill(255,0,255)
                textSize(170)
                textFont(wideAwake)
                text(masksNames[selectedMask], 400, 550)


                fill(255,255,255)
                textFont(wideAwakeBlack)
                text(masksNames[selectedMask], 400, 550)
                pop()
            }

            this.drawMaskInfo = function() {
                push()
                textAlign(CENTER)
                fill(255,0,255)
                textSize(60)
                textFont(wideAwake)
                text(masksInfo[selectedMask], 400, 650)


                fill(255,255,255)
                textFont(wideAwakeBlack)
                text(masksInfo[selectedMask], 400, 650)
                pop()
            }
            
            this.checkKeysMaskSelection = function() {
                if (millis() - cooldown > 150) {
                    if (keyIsDown(65)) {
                        cooldown = millis()
                        if (selectedMask > 0 ) {
                            selectedMask -= 1 
                        } else {
                            selectedMask = opciones.length - 1
                        }
                    }
            
                    if (keyIsDown(68)) {
                        cooldown = millis()
                        if (selectedMask < opciones.length -1 ) {
                            selectedMask += 1 
                        } else {
                            selectedMask = 0
                        }
                    }

                    if (keyIsDown(13)) {
                        cooldown = millis()
                        mgr.showScene(mainMenu)
                    }
                }
            }

            this.otherMask = function(x) {
                let indexReturn = selectedMask + x
                
                if (indexReturn < 0) {
                    return (maskImages.length) - 1
                } else if (indexReturn >= maskImages.length) {
                    return 0
                } else {
                    return indexReturn
                }
            }
        } 

        function normalMode() {

            this.draw = function() {

                if (!playing) {
                    startSong()
                    playing = true
                    startTime = millis()
                }

                if(pj.isAlive) {

                    checkKeys()

                    if (pj.ammo === 0) {
                        pj.reload(millis())
                    } 

                    checkSpawn(40)
                    background(150)
                    printKills()
                    printInfo()
                    printBullets()
                    printCross()
                    checkBulletEnemyCollision()
                    checkEnemyPjColision()
                    checkEnemyBodies()
                    enemies.forEach(enemy => enemy.dibujar(pj.x + pj.middleX, pj.y + pj.middleY, true))
                    printPj()
                    printAmmo()
                } else {
                    normalTheme.stop()
                    printDeath() 
                    checkKeysDeathNormal()
                }
            }
        }


        function nightmareTransition() {

            this.draw = function() {
                if (startNightmareTransition === 0) {
                    startNightmareTransition = millis()
                }

                background('#000000')
                push()
                fill(255, 255, 255)
                textSize(95)
                textAlign(CENTER)
                textFont(shotgunFont)
                text('YOU ARE GONNA\n HAVE A BAD\n TIME', 400, 300)
                pop()
                this.checkChange()
            }

            this.checkChange = function() {
                if ((millis() - startNightmareTransition) > 3000) {
                    startTime = millis()
                    mgr.showScene(nightmareMode)
                }
            }

        }

        function nightmareMode() {

            this.draw = function() {

                if (!playing) {
                    startSong()
                    playing = true
                }

                if(pj.isAlive) {

                    printInfo()
                    combatRoutine()
                    drawNightmare()
                    printCross()
                } else {
                    normalTheme.stop()
                    printDeath() 
                    checkKeysDeathNormal()
                }
            }
        }

        function combatRoutine() {
            checkKeys()

            if (pj.ammo === 0) {
                pj.reload(millis())
            } 

            checkSpawn(40)
            background(150)
            printKills()
            printBullets()
            checkBulletEnemyCollision()
            checkEnemyPjColision()
            checkEnemyBodies()
            enemies.forEach(enemy => enemy.dibujar(pj.x + pj.middleX, pj.y + pj.middleY, true))
            printPj()
        }

        function printDeath() {
            background(150)
            printPj()
            enemies.forEach(enemy => enemy.dibujar(pj.x + pj.middleX, pj.y + pj.middleY, false))
            image(deathOverlay, 0, 0)
            printFinalInfo()
        }

        function printFinalInfo() {
            push()
            fill('red')
            textFont(shotgunFont)
            textSize(175)
            text('You Died', 100, 200)
            textSize(50)
            textFont(wideAwake)
            text('Kills ' + killKounter, 100, 350)
            text('Time Survived  ' + Math.round(finalTime/100)/10 + '  SECONDS', 100, 450)
            text('Precission ' + Math.round(shotsLanded * 100 / shotsFired), 100, 550)
            text('Restart R', 100, 650)
            text('Back to lobby T', 100, 750)

            fill(255, 255, 255)
            textFont(wideAwakeBlack)
            text('Kills ' + killKounter, 100, 350)
            text('Time Survived  ' + Math.round(finalTime/100)/10 + '  SECONDS', 100, 450)
            text('Precission ' + Math.round(shotsLanded * 100 / shotsFired), 100, 550)
            text('Restart R', 100, 650)
            text('Back to lobby T', 100, 750)
            pop()
        }

        function startSong() {
            normalTheme.play();
        }

        function draw() {
            mgr.draw()
        }

        function drawNightmare() {
            push()
            translate(pj.x + 25, pj.y + 8)
            image(gradual, -800, -800)
            pop()

            push()
            fill(255,255,255)
            printKills()
            pop()

        }

        function checkKeysMenu() {
            if (millis() - cooldown > 150) {
                if (keyIsDown(87)) {
                    cooldown = millis()
                    if (selectedOption > 0 ) {
                        selectedOption -= 1 
                    } else {
                        selectedOption = opciones.length - 1
                    }
                }
            
                if (keyIsDown(83)) {
                    cooldown = millis()
                    if (selectedOption < opciones.length -1 ) {
                        selectedOption += 1 
                    } else {
                        selectedOption = 0
                    }
                }
            }

            if (keyIsDown(13)) {
                cooldown = millis()
                if (selectedOption === 0) {
                    mainTheme.stop()
                    playing = false 
                    mgr.showScene(normalMode)
                } else if (selectedOption === 1) {
                    mainTheme.stop()
                    playing = false
                    mgr.showScene(nightmareTransition)
                } else if (selectedOption === 3) {
                    mgr.showScene(maskSelection)
                }
            }
        }

        function checkKeys() {

            if (keyIsDown(87)) {
                if (keyIsDown(68)) {
                    pj.upRight()
                } else if (keyIsDown(65)) {
                    pj.upLeft()
                } else {
                    pj.up()
                }
            } else if (keyIsDown(83)) {
                if (keyIsDown(68)) {
                    pj.downRight()
                } else if (keyIsDown(65)) {
                    pj.downLeft()
                } else {
                    pj.down()
                }
            } else {
                if (keyIsDown(65)) {
                    pj.left()
                }
            
                if (keyIsDown(68)) {
                    pj.right()
                }
            }

            if (keyIsDown(77)) {
                pj.die()
            }

            if (mouseIsPressed) {
                if (millis() >=  mill + 100 && pj.ammo != 0) {
                    mill = millis()
                    pj.shoot(millis())
                    bullets.push(b = new bullet(pj.x + 25 ,pj.y + 8, calculateAngle() ))
                    shotM16.play()
                    shotsFired += 1
                } /*else if (pj.ammo === 0) {
                    pj.reload(millis())
                } */
            }

            if (keyIsDown(82)) {
                if (pj.ammo != 30) {
                    pj.ammo = 0
                }
            }
        }

        function checkKeysDeathNormal() {

            if (keyIsDown(82)) {
                startTime = millis()
                resetPJ()
                pj.ammo = 30
            }

            if (keyIsDown(84)) {
                startTime = millis()
                resetPJ()
                playing = false 
                mgr.showScene(mainMenu)
            }
        }

        function checkKeysDeathNightmare() {

            if (keyIsDown(82)) {
                startTime = millis()
                resetPJ()
                playing = false 
            }

            if (keyIsDown(84)) {
                startTime = millis()
                resetPJ()
                playing = false 
                mgr.showScene(nightmareMode)
            }
        }

        function resetPJ() {
            pj.isAlive = true
            pj.x = 400 - pj.middleX
            pj.y = 400 - pj.middleY
            bullets = []
            enemies = []
            killKounter = 0
            shotsFired = 0
            shotsLanded = 0
            pj.ammo = 30
            playing = false 
        }

        function calculateAngle() {
            push() 
            translate(pj.x + 25, pj.y + 8)
            let radians = atan2(mouseY - (pj.y + 8) , mouseX - (pj.x+ 25))
            pop()
            return radians
        }

        function printBullets() {
            bullets.forEach(bullet => bullet.dibujar())
            bullets.forEach(bullet => bullet.checkCollision())
            bullets = bullets.filter(bullet => bullet.onAir === true)
        }

        function checkEnemyBodies() {
            
            let contDeath = 0

            enemies.forEach(function(enemy){
                if(!enemy.isAlive) {
                    contDeath += 1
                }
            })

            if(contDeath >= 20) {
                enemies.splice(0,1)
            }
        }

        function checkBulletEnemyCollision() {
            bullets.forEach(function(bullet) {
                enemies.forEach(function(enemy) {
                    if (enemy.isAlive) {
                        let hit = false
                        hit = collideCircleCircle(bullet.x, bullet.y, 5, (enemy.x + enemy.middleX), (enemy.y + enemy.middleY), (enemy.middleX * 2) + 8)
                        if (hit) {
                            enemy.die(pj.x + pj.middleX, pj.y + pj.middleY)
                            bullet.onAir = false
                            killKounter += 1
                            shotsLanded += 1
                        }
                    }
                })
            })
        }

        function printPj() {
            if (pj.isAlive) {
                push()
                translate(pj.x + 25, pj.y + 8);
                let a = atan2(mouseY - (pj.y + 8) , mouseX - (pj.x+ 25));
                pjAngle = a + 0.07
                rotate(pjAngle);
                pj.dibujar()
                pop()
            } else {
                push()
                translate(pj.x + 25, pj.y + 8);
                rotate(pjAngle);
                pj.dibujar()
                pop()
            }

        }

        function checkEnemyPjColision() {
            enemies.forEach(function(enemy) {
                if (enemy.isAlive) {
                    let hit = false 
                    hit = collideCircleCircle((pj.x + pj.middleX), (pj.y + pj.middleY), pj.middleY, (enemy.x + enemy.middleX), (enemy.y + enemy.middleY), enemy.middleX * 2)
                    if (hit) {
                        finalTime = millis() - startTime
                        pj.isAlive = false
                    }
                }
            })
        }

        function printAmmo() {

            let ammo = pj.ammo 

            if (ammo != 0) {
                text('ammo: ' + pj.ammo + '/' + pj.maxAmmo, 700,790)
            } else {
                text('Reloading...' , 700,790)
            }
        }

        function calculateRandomMN(m, n) {
            return Math.round(Math.random()*(m-n)+n)
        }

        function printInfo() {
            text('Clk izq: disparar - wasd: movimiento - r: recargar', 7, 15 )
        }

        // spawn functions 

        function spawnDog() {
            let position = calculateSpawn()
            enemies.push(new dog(position[0], position[1]))
        }

        function spawnKnife() {
            let position = calculateSpawn() 
            enemies.push(new enemyKnife(position[0], position[1]))
        }

        function checkSpawn(n) {

            checkSpawnCap()
            checkSpawnTime()

            if (millis() - lastSpawn > spawnTime) {
                console.log(millis() - lastSpawn + '   ' + spawnTime)
                spawnRandomEnemy()
            } else {
                if (millis() - lastSpawn > spawnCap) {

                    let decision = calculateRandomMN(n,1)

                    if (decision === 1) {
                        spawnRandomEnemy()
                    }
                }
            }


        }

        function checkSpawnTime() {
            let milsCheckTime = millis() - startTime
            console.log(milsCheckTime)
            if (milsCheckTime < 30000) {
                spawnTime = 1500
            } else if (milsCheckTime > 30000 && milsCheckTime < 60000) {
                spawnTime = 1250
            } else if (milsCheckTime > 6000 && milsCheckTime < 18000) {
                spawntime = 800
            } else {
                spawnTime = 500
            }
        }

        function checkSpawnCap() {
            let milsCheckCap = millis() - startTime
            if (milsCheckCap < 30000) {
                spawnCap = 300
            } else if (milsCheckCap > 30000 && milsCheckCap < 60000) {
                spawTime = 250
            } else if (milsCheckCap > 6000 && milsCheckCap < 18000) {
                spawntime = 200
            } else {
                spawnTime = 100
            }
        }

        function spawnRandomEnemy() {
            let decision = coinflip()

            let coord = calculateSpawn() 

            if (decision === 1) {
                enemies.push(new dog(coord[0], coord[1]))
            } else {
                enemies.push(new enemyKnife(coord[0], coord[1]))
            }
            lastSpawn = millis()
        }

        // functions to determine spawn point in the perimeter equivalent to 
        // a rectangle with coordinates 
        // [[-100, -100], [900, -100], [-100, 900], [900, 900]] 
        function coinflip() {
            return Math.round(Math.random()*(2-1)+1)
        }

        function calculateSpawn() {
            let decision =  coinflip()

            if (decision === 1) {
                return calculateArroundX()
            } else {
                return calculateArroundY()
            }
        }

        function calculateArroundX() {
            let decision = coinflip()

            let x = 0
            let y = calculateSecondPosition()

            if (decision === 1) {
                x = -100 
            } else {
                x = 900
            }

            return [x, y] 
        }

        function calculateArroundY() {
            let decision = coinflip()

            let y = 0
            let x = calculateSecondPosition()

            if (decision === 1) {
                y = -100 
            } else {
                y = 900
            }           

            return [x, y]
        }

        function calculateSecondPosition() {
            let decision = calculateRandomMN(10,1)

            if (decision === 1) {
                return (calculateRandomMN(100, 0) * (-1))
            } else {
                return calculateRandomMN(900,0)
            }
        }

        function printKills() {
            text('kills: ' + killKounter , 10, 790)
        }

        function printCross () {
            image(cursor, mouseX - 9, mouseY - 9)
        }

    </script>
</body>
</html>