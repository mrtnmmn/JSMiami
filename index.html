<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSMiami</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"
    integrity="sha512-N4kV7GkNv7QR7RX9YF/olywyIgIwNvfEe2nZtfyj73HdjCUkAfOBDbcuJ/cTaN04JKRnw1YG1wnUyNKMsNgg3g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"
    integrity="sha512-WzkwpdWEMAY/W8WvP9KS2/VI6zkgejR4/KTxTl4qHx0utqeyVE0JY+S1DlMuxDChC7x0oXtk/ESji6a0lP/Tdg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="libraries/scenemanager.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script defer src="https://unpkg.com/p5.collide2d"></script>
    <script src="scripts/pj.js"></script>
    <script src="scripts/bullet.js"></script>
    <script src="scripts/enemies/dog.js"></script>
    <script src="scripts/enemies/enemyKnife.js"></script>
    <script src="scripts/enemies/enemyM16.js"></script>

</head>
<body>
    <script>
        let pj
        let pjAngle
        let mill = 0

        // borrar: 
        let milldog = 0

        let bullets = []
        let enemies = []

        let shotsFired = 0
        let shotsLanded = 0
        let killKounter = 0
        let startTime = 0
        let finalTime = 0

        let round1 = []

        let mainTheme 
        let playing = false 
        let shotM16

        let gradual
        let deathOverlay

        let startTransition

        function preload() {
            mainTheme = loadSound('sounds/soundtrack/horseStepping.mp3')
            normalTheme = loadSound('sounds/soundtrack/hydrogen.mp3')
            shotgunFont = loadFont('fonts/shotgun.ttf')
        }

        function setup() {
            shotM16 = loadSound('sounds/shots/M16Shot.mp3')
            gradual = loadImage('sprites/nightmare/nightmare_big.png')
            deathOverlay = loadImage('sprites/overlay_death.png')
            createCanvas(800 , 800)
            pj = new Pj()

            mgr = new SceneManager()

            mgr.addScene(mainMenu)
            mgr.addScene(normalMode)
            mgr.addScene(nightmareTransition)
            mgr.addScene(nightmareMode)

            mgr.showScene(mainMenu)
        }

        function mainMenu() {

            let enemy = new enemyM16(800,800, true)

            if (!playing) {
                mainTheme.play()
                playing = true

            }

            circles = [[200,200,50, 0], [600,200,50, 1]]

            this.draw = function() {

                background(150)

                push()
                textFont(shotgunFont)
                text('Normal', 100, 100 )
                pop()

                circle(200,200,50)
                circle(600,200,50)

                checkKeys()
                printBullets()
                printPj()

                enemy.dibujar(pj.x, pj.y, true)

                this.checkBullet()
 
            }

            this.checkBullet = function() {
                bullets.forEach(function(bullet) {
                    circles.forEach(function(circle) { 
                        let hit = false 
                        hit = collideCircleCircle(bullet.x, bullet.y, 5, circle[0], circle[1], circle[2])
                        if (hit) {
                            if (circle[3] === 1) {
                                mainTheme.stop()
                                playing = false
                                startTransition = millis()
                                pj.x = 400
                                pj.y = 400
                                bullets = []
                                startTime = millis()
                                shotsFired = 0
                                mgr.showScene(nightmareTransition)
                            }
                            else if (circle[3] === 0) {
                                mainTheme.stop()
                                playing = false
                                bullets = []
                                shotsFired = 0
                                mgr.showScene(normalMode)
                            }
                        }
                    })
                })
            }

        }

        function normalMode() {

            this.draw = function() {
                if (!playing) {
                    startSong()
                    playing = true
                }

                if(pj.isAlive) {

                    checkKeys()

                    if (pj.ammo === 0) {
                        pj.reload(millis())
                    } 

                    checkSpawn(40)
                    background(150)
                    printKills()
                    printInfo()
                    printBullets()
                    checkBulletEnemyCollision()
                    checkEnemyPjColision()
                    checkEnemyBodies()
                    enemies.forEach(enemy => enemy.dibujar(pj.x + pj.middleX, pj.y + pj.middleY, true))
                    printPj()
                    printAmmo()
                } else {
                    printDeath() 
                    checkKeysDeathNormal()
                }
            }
        }


        function nightmareTransition() {

            this.draw = function() {
                background('#000000')
                push()
                fill(255, 255, 255)
                textSize(95)
                textAlign(CENTER)
                textFont(shotgunFont)
                text('YOU ARE GONNA\n HAVE A BAD\n TIME', 400, 300)
                pop()
                this.checkChange()
            }

            this.checkChange = function() {
                console.log(millis() - this.start)
                if ((millis() - startTransition) > 2500) {
                    startTime = millis()
                    mgr.showScene(nightmareMode)
                }
            }

        }

        function nightmareMode() {

            this.draw = function() {

                if (!playing) {
                    startSong()
                    playing = true
                }

                if(pj.isAlive) {

                    printInfo()
                    combatRoutine()
                    drawNightmare()
                } else {

                }
            }
        }

        function combatRoutine() {
            checkKeys()

            if (pj.ammo === 0) {
                pj.reload(millis())
            } 

            checkSpawn(40)
            background(150)
            printKills()
            printBullets()
            checkBulletEnemyCollision()
            checkEnemyPjColision()
            checkEnemyBodies()
            enemies.forEach(enemy => enemy.dibujar(pj.x + pj.middleX, pj.y + pj.middleY, true))
            printPj()
        }

        function printDeath() {
            background(150)
            printPj()
            enemies.forEach(enemy => enemy.dibujar(pj.x + pj.middleX, pj.y + pj.middleY, false))
            image(deathOverlay, 0, 0)
            printFinalInfo()
        }

        function printFinalInfo() {
            push()
            fill('red')
            textFont(shotgunFont)
            textSize(175)
            text('You Died', 100, 200)
            textSize(50)
            text('Kills ' + killKounter, 100, 350)
            text('Time Survived  ' + Math.round(finalTime/100)/10 + '  SECONDS', 100, 450)
            text('Precission ' + Math.round(shotsLanded * 100 / shotsFired) + ' %', 100, 550)
            text('Restart R', 100, 650)
            text('Back to lobby T', 100, 750)
            pop()
        }

        function startSong() {
            normalTheme.play();
        }

        function draw() {
            mgr.draw()
        }

        function drawNightmare() {
            push()
            translate(pj.x + 25, pj.y + 8)
            image(gradual, -800, -800)
            pop()

            push()
            fill(255,255,255)
            printKills()
            pop()

        }

        function checkKeys() {
            if (keyIsDown(65)) {
                pj.left()
            }

            if (keyIsDown(68)) {
                pj.right()
            }

            if (keyIsDown(87)) {
                pj.up()
            }
            
            if (keyIsDown(83)) {
                pj.down()
            }

            if (keyIsDown(77)) {
                pj.die()
            }

            if (mouseIsPressed) {
                if (millis() >=  mill + 100 && pj.ammo != 0) {
                    mill = millis()
                    pj.shoot(millis())
                    bullets.push(b = new bullet(pj.x + 25 ,pj.y + 8, calculateAngle() ))
                    shotM16.play()
                    shotsFired += 1
                } /*else if (pj.ammo === 0) {
                    pj.reload(millis())
                } */
            }

            if (keyIsDown(82)) {
                if (pj.ammo != 30) {
                    pj.ammo = 0
                }
            }
        }

        function checkKeysDeathNormal() {
            if (keyIsDown(82)) {
                startTime = millis()
                pj.isAlive = true
                pj.x = 400
                pj.y = 400
                normalTheme.stop()
                bullets = []
                enemies = []
                killKounter = 0
                shotsFired = 0
                shotsLanded = 0
                pj.ammo = 30
                playing = false 
            }

            if (keyIsDown(84)) {
                mgr.showScene(mainMenu)
            }
        }

        function calculateAngle() {
            push() 
            translate(pj.x + 25, pj.y + 8)
            let radians = atan2(mouseY - (pj.y + 8) , mouseX - (pj.x+ 25))
            pop()
            return radians
        }

        function printBullets() {
            bullets.forEach(bullet => bullet.dibujar())
            bullets.forEach(bullet => bullet.checkCollision())
            bullets = bullets.filter(bullet => bullet.onAir === true)
        }

        function checkEnemyBodies() {
            
            let contDeath = 0

            enemies.forEach(function(enemy){
                if(!enemy.isAlive) {
                    contDeath += 1
                }
            })

            if(contDeath >= 20) {
                enemies.splice(0,1)
            }
        }

        function checkBulletEnemyCollision() {
            bullets.forEach(function(bullet) {
                enemies.forEach(function(enemy) {
                    if (enemy.isAlive) {
                        let hit = false
                        hit = collideCircleCircle(bullet.x, bullet.y, 5, (enemy.x + enemy.middleX), (enemy.y + enemy.middleY), enemy.middleX * 2)
                        if (hit) {
                            enemy.die(pj.x + pj.middleX, pj.y + pj.middleY)
                            bullet.onAir = false
                            killKounter += 1
                            shotsLanded += 1
                            console.log('hit')
                        }
                    }
                })
            })
        }

        function printPj() {
            if (pj.isAlive) {
                push()
                translate(pj.x + 25, pj.y + 8);
                let a = atan2(mouseY - (pj.y + 8) , mouseX - (pj.x+ 25));
                pjAngle = a + 0.07
                rotate(pjAngle);
                pj.dibujar()
                pop()
            } else {
                push()
                translate(pj.x + 25, pj.y + 8);
                rotate(pjAngle);
                pj.dibujar()
                pop()
            }

        }

        function checkEnemyPjColision() {
            enemies.forEach(function(enemy) {
                if (enemy.isAlive) {
                    let hit = false 
                    hit = collideCircleCircle((pj.x + pj.middleX), (pj.y + pj.middleY), pj.middleY, (enemy.x + enemy.middleX), (enemy.y + enemy.middleY), enemy.middleX * 2)
                    if (hit) {
                        finalTime = millis() - startTime
                        pj.isAlive = false
                    }
                }
            })
        }

        function printAmmo() {

            let ammo = pj.ammo 

            if (ammo != 0) {
                text('ammo: ' + pj.ammo + '/' + pj.maxAmmo, 700,790)
            } else {
                text('Reloading...' , 700,790)
            }
        }

        function calculateRandomMN(m, n) {
            return Math.round(Math.random()*(m-n)+n)
        }

        function printInfo() {
            text('Clk izq: disparar - wasd: movimiento - r: recargar', 7, 15 )
        }

        // rounds
        round1.forEach(function(func) {
            func()   
        })


        // spawn functions 

        function spawnDog() {
            let position = calculateSpawn()
            enemies.push(new dog(position[0], position[1]))
        }

        function spawnKnife() {
            let position = calculateSpawn() 
            enemies.push(new enemyKnife(position[0], position[1]))
        }

        function checkSpawn(n) {
            decision = calculateRandomMN(n,1)

            if (decision === 1) {
                spawnRandomEnemy()
            }
        }

        function spawnRandomEnemy() {
            let decision = coinflip()

            let coord = calculateSpawn() 

            if (decision === 1) {
                enemies.push(new dog(coord[0], coord[1]))
            } else {
                enemies.push(new enemyKnife(coord[0], coord[1]))
            }
        }

        // functions to determine spawn point in the perimeter equivalent to 
        // a rectangle with coordinates 
        // [[-100, -100], [900, -100], [-100, 900], [900, 900]] 
        function coinflip() {
            return Math.round(Math.random()*(2-1)+1)
        }

        function calculateSpawn() {
            let decision =  coinflip()

            if (decision === 1) {
                return calculateArroundX()
            } else {
                return calculateArroundY()
            }
        }

        function calculateArroundX() {
            let decision = coinflip()

            let x = 0
            let y = calculateSecondPosition()

            if (decision === 1) {
                x = -100 
            } else {
                x = 900
            }

            return [x, y] 
        }

        function calculateArroundY() {
            let decision = coinflip()

            let y = 0
            let x = calculateSecondPosition()

            if (decision === 1) {
                y = -100 
            } else {
                y = 900
            }           

            return [x, y]
        }

        function calculateSecondPosition() {
            let decision = calculateRandomMN(10,1)

            if (decision === 1) {
                return (calculateRandomMN(100, 0) * (-1))
            } else {
                return calculateRandomMN(900,0)
            }
        }

        function printKills() {
            text('kills: ' + killKounter , 10, 790)
        }

    </script>
</body>
</html>